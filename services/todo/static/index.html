<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%2210 0 100 100%22><text y=%22.90em%22 font-size=%2290%22>üóí</text></svg>"></link>
    <title>Todo List Application</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/foundation-sites@6.7.5/dist/css/foundation.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <style>
        .divider {
            border-top: 1px solid #e6e6e6;
            margin: 10px 0;
        }
        .no-tasks-message {
            text-align: center;
            color: #888;
            margin-top: 15px;
        }
        .delete-button-container {
            display: flex;
            align-items: center;
        }
    </style>
</head>
<body>
    <div class="grid-container">
        
        <!-- Title -->
        <div class="grid-x grid-padding-x align-center">
            <div class="cell small-12 medium-8 large-6">
                <h2 class="text-center" style="margin-top: 120px; margin-bottom: 30px;">üìù My Todo List</h2>
            </div>
        </div>

        <!-- Input Form -->
        <div class="grid-x grid-padding-x align-center">
            <div class="cell small-12 medium-8 large-6">
                <div class="input-group">
                    <input class="input-group-field" type="text" id="newTask" placeholder="Enter a new task">
                    <div class="input-group-button">
                        <button class="button" id="addTaskButton">Add Task</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Task List -->
        <div class="grid-x grid-padding-x align-center">
            <div class="cell small-12 medium-8 large-6">
                <div class="card">
                    <div class="card-section">
                        <p id="noTasksText" class="no-tasks-message">No tasks</p>
                        <p id="addTaskHintText" class="no-tasks-message">Use the input above to add a new task.</p>
                        <ul id="taskList" class="no-bullet">
                            <!-- Task items will go here -->
                        </ul>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/foundation-sites@6.7.5/dist/js/foundation.min.js"></script>
    <script>
        const addTaskButton = document.getElementById('addTaskButton');
        const newTaskInput = document.getElementById('newTask');
        const taskList = document.getElementById('taskList');
        const noTasksText = document.getElementById('noTasksText');
        const addTaskHintText = document.getElementById('addTaskHintText');

        // Add new task
        addTaskButton.addEventListener('click', async function(e) {
            e.preventDefault();
            const taskText = newTaskInput.value.trim();
            if (taskText === '') {
                alert('Please enter a task!');
                return;
            }

            await fetch('/api/todo/tasks', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ item: taskText })
            });

            fetchTasks();               // Refresh task list
            newTaskInput.value = '';    // Clear input
        });

        function updateDividers() {
            const tasks = taskList.querySelectorAll('li');
            const dividers = taskList.querySelectorAll('.divider');
            dividers.forEach(div => div.remove());

            tasks.forEach((task, index) => {
                if (index < tasks.length - 1) {
                    const divider = document.createElement('div');
                    divider.classList.add('divider');
                    task.after(divider);
                }
            });
        }

        function toggleNoTasksText() {
            const hasTasks = taskList.children.length > 0;
            noTasksText.style.display = hasTasks ? 'none' : 'block';
            addTaskHintText.style.display = hasTasks ? 'none' : 'block';
        }

        // Delete a task
        async function deleteTask(taskName) {
            try {
                await fetch('/api/todo/tasks', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ item: taskName })
                });

                // remove the removed task from the list
                const tasks = taskList.querySelectorAll('li');
                const numTasks = tasks.length;
                tasks.forEach((task, index) => {
                    let currTaskItem = task;
                    if (currTaskItem.textContent == taskName) {
                        if (index < numTasks - 1) {
                            let removedItemDivider = currTaskItem.nextSibling;
                            removedItemDivider.remove();
                        }
                        currTaskItem.remove();
                    }
                });

            } catch(error) {
                alert("failed to delete item: " + error);
            }
        }

        // Fetch and display tasks
        async function fetchTasks() {
            try {
                const response = await fetch('/api/todo/tasks');
                const tasks = await response.json();
                
                // clear existing tasks
                taskList.innerHTML = '';

                // display all tasks
                tasks.forEach(taskText => {
                    const taskItem = document.createElement('li');
                    taskItem.classList.add('grid-x', 'grid-padding-x', 'align-middle');

                    // display task's text
                    const taskContent = document.createElement('div');
                    taskContent.classList.add('cell', 'auto');
                    taskContent.textContent = taskText;

                    // create delete button container
                    const deleteButtonContainer = document.createElement('div');
                    deleteButtonContainer.classList.add('cell', 'shrink', 'delete-button-container');
                    
                    // create handler for the delete button
                    const deleteButton = document.createElement('button');
                    deleteButton.classList.add('button', 'alert', 'small');
                    deleteButton.style.margin = 0;
                    deleteButton.innerHTML = '<i class="fas fa-trash"></i>';
                    deleteButton.addEventListener('click', function(e) {
                        deleteTask(taskText);
                    });

                    // add the delete button into the task display
                    deleteButtonContainer.appendChild(deleteButton);
                    taskItem.appendChild(taskContent);
                    taskItem.appendChild(deleteButtonContainer);

                    taskList.appendChild(taskItem);
                });
            } catch(error) {
                alert("failed to load item: " + error);
            }

            updateDividers();
            toggleNoTasksText();
        }

        // On page load: display no-task text if needed, 
        // and fetch tasks from the backend.
        toggleNoTasksText();
        fetchTasks();
    </script>

</body>
</html>
